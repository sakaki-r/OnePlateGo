<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>çŒ®ç«‹çµæœ</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">
</head>

<body class="menubody">
  <div class="page-container">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header-bar">
      <h1 class="site-title">é¸ã°ã‚ŒãŸçŒ®ç«‹</h1>
      <div class="user-info" th:if="${#authorization.expression('isAuthenticated()')}">
        <span th:text="${#authentication.name + ' ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼'}"></span>
        <a th:href="@{/logout}" class="logout-link">ğŸ”“ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
      </div>
    </div>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
    <div th:if="${message != null}" class="message-box">
      <p th:text="${message}"></p>
    </div>

    <div class="main-container">
      <!-- å·¦å´ï¼šé¸ã°ã‚ŒãŸçŒ®ç«‹ -->
      <div class="chosenmeal">
        <ul class="meal-list">
          <li th:each="meal : ${selectedMeals}" th:with="mealKey=${meal.category + '-' + meal.id}" class="meal-list-item">
            <img th:src="@{${meal.imagePath}}" alt="æ–™ç†ç”»åƒ" class="meal-thumb">
            <div class="meal-content">
              <div class="meal-header">
                <label class="meal-label">
                  <input type="checkbox" name="keepIds" th:value="${mealKey}"
                    th:checked="${keepIds != null and keepIds.contains(mealKey)}" />
                  <span th:text="${meal.maindish}"></span>
                  <span th:if="${meal.sidedish != null}" th:text="'ï¼ˆ' + ${meal.sidedish} + 'ï¼‰'"></span>
                </label>

                <!-- ãŠæ°—ã«å…¥ã‚Šè¿½åŠ ï¼šãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã¿è¡¨ç¤º -->
                <div th:if="${#authorization.expression('isAuthenticated()')}">
                  <form class="favorite-form" 
                    th:attr="data-dishid=${meal.id}, data-dishtype=${meal.category == 1 ? 'meat' : (meal.category == 2 ? 'fish' : 'other')}">
                    <button type="submit">â˜… ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ </button>
                  </form>
                </div>
              </div>

              <!-- ææ–™ãƒªã‚¹ãƒˆ -->
              <ul class="ingredient-nested-list">
                <li th:each="ing : ${meal.ingredients}">
                  <span th:text="${ing}"></span>
                </li>
              </ul>
            </div>
          </li>
        </ul>

        <!-- æ¨ªä¸¦ã³ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
        <div class="action-buttons">
          <!-- å†ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
          <form id="reselectForm" action="/reselect" method="post" th:object="${mealRequest}">
            <input type="hidden" th:field="*{mealCount}" />
            <input type="hidden" th:field="*{meatCount}" />
            <input type="hidden" th:field="*{fishCount}" />
            <input type="hidden" th:field="*{otherCount}" />
            <div id="keepInputsContainer"></div>
             <button type="submit" class="btn-dotted">ğŸ½ï¸ æ®‹ã‚Šã®çŒ®ç«‹ã‚’å†ä½œæˆ</button>
          </form>

          <!-- ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ãƒªãƒ³ã‚¯ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã¿ï¼‰ -->
          <div th:if="${#authorization.expression('isAuthenticated()')}">
            <a th:href="@{/myfavorites}" class="btn-dotted">â¤ï¸ ãŠæ°—ã«å…¥ã‚Šä¸€è¦§</a>
          </div>
        </div>
      </div>

      <!-- å³å´ï¼šè²·ã„ç‰©ãƒªã‚¹ãƒˆ -->
      <div class="ingredientlist">
        <h2>ğŸ›’ è²·ã„ç‰©ãƒªã‚¹ãƒˆ</h2>
        <table class="ingredients-table">
          <tbody>
            <tr th:each="ing : ${ingredients}">
              <td class="checkbox-col"><input type="checkbox" /></td>
              <td th:text="${ing}"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <footer class="footer-nav">
    <a href="/" class="fotterbtn">ğŸ½ï¸HOME</a>
    <p class="copyright">Â© One Plate Go</p>
  </footer>

  <!-- JavaScript -->
  <script>
    document.querySelectorAll(".favorite-form").forEach(form => {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        const dishId = form.dataset.dishid;
        const dishType = form.dataset.dishtype;

        const params = new URLSearchParams();
        params.append("dishId", dishId);
        params.append("dishType", dishType);

        fetch('/myfavorites/add-json', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: params.toString()
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === "added") {
            alert("âœ… ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ã¾ã—ãŸï¼");
          } else if (data.status === "duplicate") {
            alert("âš  ã™ã§ã«ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚");
          } else if (data.status === "unauthorized") {
            alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
            window.location.href = "/login";
          } else {
            alert("è¿½åŠ å¤±æ•—ã—ã¾ã—ãŸ");
          }
        })
        .catch(() => {
          alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        });
      });
    });

    // å†ä½œæˆæ™‚ã®keepIdså‹•çš„ã‚»ãƒƒãƒˆ
    document.getElementById('reselectForm').addEventListener('submit', function (e) {
      const container = document.getElementById('keepInputsContainer');
      container.innerHTML = '';
      document.querySelectorAll('input[name="keepIds"]:checked').forEach(cb => {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'keepIds';
        hidden.value = cb.value;
        container.appendChild(hidden);
      });
    });
  </script>
</body>
</html>
